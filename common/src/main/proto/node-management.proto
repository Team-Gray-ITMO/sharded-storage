syntax = "proto3";

option java_multiple_files = true;
option java_package = "vk.itmo.teamgray.sharded.storage.node.management";

package vk.itmo.teamgray.sharded.storage;

service NodeManagementService {
  rpc RearrangeShards (RearrangeShardsRequest) returns (RearrangeShardsResponse);
  rpc MoveShard (MoveShardRequest) returns (MoveShardResponse);
  rpc RollbackTopologyChange (RollbackTopologyChangeRequest) returns (RollbackTopologyChangeResponse);
}

message RearrangeShardsRequest {
  // Sorted map of upper bound hash (inclusive) by shard number, lower bound is defined by previous shard (exclusive)
  // For rearrange request, only relevant shards will be included
  map<int32, int64> shardToHash = 1;

  repeated MoveFragment fragments = 2;

  map<int32, Server> serverByShardNumber = 3;
}

message RearrangeShardsResponse {
  bool success = 1;
  string message = 2;
}

message ServerData {
  string host = 1;
  int32 port = 2;
}

message MoveShardRequest {
  int32 shardId = 1;
  ServerData targetServer = 2;
}

message MoveShardResponse {
  bool success = 1;
  string message = 2;
}

message MoveFragment {
  int32 shardFrom = 1;

  int32 shardTo = 2;

  int64 rangeFrom = 3;

  int64 rangeTo = 4;
}

message Server {
  string ip = 1;

  int32 port = 2;
}

message RollbackTopologyChangeRequest {
  // Empty, node knows its previous state
}

message RollbackTopologyChangeResponse {
  bool success = 1;
  string message = 2; // For status/error
}
